# !/usr/bin/env python
# -*- coding:utf:8 -*-

from dmod import mod
from pyomo.environ import *
from pyomo.dae import *

t = TransformationFactory("dae.collocation")
t.apply_to(mod, nfe=1, ncp=1)

#: initial condition

m0 = {}
m0[1] = 104841.840518209
m0[2] = 3365.15063880891
m0[3] = 3377.64423703005
m0[4] = 3394.19394793689
m0[5] = 3415.97028220401
m0[6] = 3443.60195261468
m0[7] = 3477.12562768577
m0[8] = 3515.71242179662
m0[9] = 3557.61114046722
m0[10] = 3600.42331701469
m0[11] = 3641.63813449096
m0[12] = 3679.18572175288
m0[13] = 3711.77239776736
m0[14] = 3738.92135748066
m0[15] = 3760.80100924688
m0[16] = 3777.97695831935
m0[17] = 3791.18900565631
m0[18] = 3801.19564691092
m0[19] = 3808.68649735454
m0[20] = 3814.2451828833
m0[21] = 3818.34318288733
m0[22] = 2966.95264370854
m0[23] = 2996.07213641066
m0[24] = 3033.22825932473
m0[25] = 3080.91646148223
m0[26] = 3140.54617376401
m0[27] = 3212.80812790314
m0[28] = 3297.319204213
m0[29] = 3392.42487306169
m0[30] = 3495.28826639159
m0[31] = 3602.26957382648
m0[32] = 3709.47367372904
m0[33] = 3813.29079973808
m0[34] = 3910.79265637048
m0[35] = 3999.92843977372
m0[36] = 4079.53802267039
m0[37] = 4149.23849454769
m0[38] = 4209.247272374
m0[39] = 4260.19289255129
m0[40] = 4302.94587906738
m0[41] = 4338.48482895857
m0[42] = 4715.08346542075

x0 = {}
x0[1] = 0.00899022638731442
x0[2] = 0.0191886263281775
x0[3] = 0.0293363827972093
x0[4] = 0.0428962785598474
x0[5] = 0.0604471896087129
x0[6] = 0.0822648356220905
x0[7] = 0.10809578510944
x0[8] = 0.137017731303448
x0[9] = 0.167507051792055
x0[10] = 0.197742953894711
x0[11] = 0.226028519577584
x0[12] = 0.251133548946962
x0[13] = 0.272431920923085
x0[14] = 0.289840800449635
x0[15] = 0.303653960011903
x0[16] = 0.314363072601107
x0[17] = 0.322519324703368
x0[18] = 0.328647768603237
x0[19] = 0.333205409519584
x0[20] = 0.336568195714045
x0[21] = 0.339034022751531
x0[22] = 0.363901047383348
x0[23] = 0.382373838153731
x0[24] = 0.405892302718829
x0[25] = 0.43528247881571
x0[26] = 0.470804182320203
x0[27] = 0.512106265442575
x0[28] = 0.558125731008321
x0[29] = 0.607171057811349
x0[30] = 0.657194252111702
x0[31] = 0.706154559798086
x0[32] = 0.752336692142859
x0[33] = 0.794531082895909
x0[34] = 0.832064473974036
x0[35] = 0.864725774525591
x0[36] = 0.892645507131839
x0[37] = 0.916172838961342
x0[38] = 0.935773277385404
x0[39] = 0.951954024128839
x0[40] = 0.9652150615812
x0[41] = 0.976020549213358
x0[42] = 0.984784667857339

for i in range(1, 43):
    mod.M_ic[i].set_value(m0[i])
    mod.x_ic[i].set_value(x0[i])

vml = 0.5 * ((1 / 2288) * 0.2685 ** (1 + (1 - 100 / 512.4) ** 0.2453)) + \
      0.5 * ((1 / 1235) * 0.27136 ** (1 + (1 - 100 / 536.4) ** 0.24))
vmu = 0.5 * ((1 / 2288) * 0.2685 ** (1 + (1 - (512.4 - 1E-08) / 512.4) ** 0.2453)) + \
      0.5 * ((1 / 1235) * 0.27136 ** (1 + (1 - 512.4 / 536.4) ** 0.24))

mod.M[:, :].setlb(-1E-08)
mod.L[:, :].setlb(-1E-08)
mod.V[:, :].setlb(-1E-08)

mod.Mv[:, :].setlb(0.155 - 1E-08)
mod.Mv1[:].setlb(8.5 - 1E-08)
mod.Mvn[:].setlb(0.17 - 1E-08)
#
# mod.Mv[:, :].setlb(0.155)
# mod.Mv[:, 1].setlb(8.5)
# mod.Mv[:, 42].setlb(0.17)

mod.T[:, :].setlb(100.0)
mod.T[:, :].setub(512.4 - 1E-08)

mod.y[:, :].setlb(-1E-11)
mod.x[:, :].setlb(-1E-11)

mod.y[:, :].setub(1.0 + 1E-11)
mod.x[:, :].setub(1.0 + 1E-11)
mod.Vm[:, :].setlb(vml)
mod.Vm[:, :].setub(vmu)

mod.o = Objective(expr=(mod.u2[mod.t.last()] - value(mod.Qr[mod.t.last()])) ** 2)
# ip = SolverFactory('/home/dav0/PycharmProjects/ipopt_van/build/bin/ipopt')
ip = SolverFactory("/home/dav0/in_dev_/ipopt_vanilla_l1/builds/ipopt_l1/bin/ipopt")
ip.options["halt_on_ampl_error"] = "yes"
ip.options["linear_solver"] = "ma57"
ip.solve(mod, tee=True, symbolic_solver_labels=True)
ip.options["bound_push"] = 1.0
ip.solve(mod, tee=True, symbolic_solver_labels=True)
mod.pprint(filename="pprint.txt")
mod.display(filename="disp.txt")
